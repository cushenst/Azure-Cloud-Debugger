<!DOCTYPE HTML>
<html lang="en">
<head>


    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta content="width=device-width, initial-scale=1, shrink-to-fit=no" name="viewport">

    <!-- Bootstrap CSS -->
    <link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.0/css/bootstrap.min.css" rel="stylesheet">
    <link href="/static/index.css" rel="stylesheet" type="text/css">
    <title>Azure IoT Hub Cloud Subscriber</title>
</head>
<body>
<header>
    <nav class="navbar navbar-inverse">
        <div class="container-fluid">
            <div class="nav navbar-nav navbar-center">
                <a class="navbar-brand" href="#">Azure IoT Hub Cloud Subscriber</a>
            </div>
        </div>
    </nav>
</header>

<div style="text-align: center;">
    <table align="center">
        <tr>
            <th>Azure Endpoint String:</th>
            <td><label for="Endpoint"></label><input id="Endpoint" size="30" type="text"/></td>
        </tr>
        <tr>
            <th><h4>Device to listen to messages from (optional):</h4></th>
            <td><label for="Device"></label><input id="Device" size="30" type="text"/></td>
        </tr>

        <tr>
            <th>Topic to subscribe to (optional):</th>
            <td><label for="Topic"></label><input id="Topic" size="30" type="text"/></td>
        </tr>
    </table>
    <br>
    <br>
    <button id="button">Submit</button>

</div>
<div class="container">
    <div class="row col-sm-12 displaystyle-leftborder displaystyle-info displaystyle-lg" id="WelcomeBox">
        <p id="WelcomeMessage">Please enter the connection Endpoint String.
    </div>
    <div class="row col-sm-12 displaystyle-leftborder displaystyle-success displaystyle-lg" hidden id="ConnectionBox">
        <p id="ConnectionMessage">Connection Successful. Waiting for messages.
    </div>

    <div class="row col-sm-12 displaystyle-leftborder displaystyle-success displaystyle-lg" hidden id="ConnectingBox">
        <p>Connecting....
    </div>

    <div class="row col-sm-12 displaystyle-leftborder displaystyle-danger displaystyle-lg" hidden id="ErrorBox">
        <p>Error: Please re-enter the connection string or refresh your browser.</p>
    </div>
</div>


<!-- jQuery -->
<script crossorigin="anonymous"
        integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo"
        src="https://code.jquery.com/jquery-3.3.1.slim.min.js"></script>


<script type="text/javascript">

    $(function () {
        // if user is running mozilla then use it"s built-in WebSocket
        window.WebSocket = window.WebSocket || window.MozWebSocket;

        //open websocket server on port 1337
        var connection = new WebSocket("ws://127.0.0.1:1337");
        connection.onopen = function () {
            // connection is opened and ready to use
        };

        connection.onerror = function (error) {
            // an error occurred when sending/receiving data
        };

        connection.onmessage = function (message) {
            console.log(message.data);
            // try to decode json (I assume that each correct message
            // from server is json)
            try {
                var json = JSON.parse(message.data);
                console.log(json);
                //check if it is connected to Azure
                if (json.Connected === "True") {
                    document.getElementById("ConnectionBox").hidden = false;
                    document.getElementById("ConnectingBox").hidden = true;
                } else {
                    document.getElementById("ConnectionBox").hidden = true;
                    //get the place the messages are going to be displayed
                    var messagesDiv = document.querySelector('.container');
                    //insert the new message at the top of the page
                    messagesDiv.insertAdjacentHTML('afterbegin',
                        '<div class="row col-sm-12 displaystyle-leftborder displaystyle-info displaystyle-lg">' +
                        '<table><tr><th>Device:</th><td>' +
                        String(json.Device) +
                        '</td></tr><tr><th>Topic:</th><td>' +
                        String(json.Topic) +
                        '</td></tr><tr><th>Message:</th><td>' +
                        String(json.Payload) +
                        '</td></tr></table></div>');
                }
            } catch (e) {
                //if an error message has been returned
                console.log("This doesn\"t look like a valid JSON: ",
                    message.data);
                document.getElementById("ConnectingBox").hidden = true;
                document.getElementById("Endpoint").disabled = false;
                document.getElementById("Device").disabled = false;
                document.getElementById("Topic").disabled = false;
                document.getElementById("button").disabled = false;
                document.getElementById("WelcomeBox").hidden = true;
                document.getElementById("ConnectionBox").hidden = true;
                document.getElementById("ErrorBox").hidden = false;


            }
        };

        document.getElementById("button").onclick = function () {
            //get values of the input boxes
            var Endpoint = $("#Endpoint").val();
            var Device = $("#Device").val();
            var Topic = $("#Topic").val();
            var msg = {"Endpoint": Endpoint, "Device": Device, "Topic": Topic};
            var msgJSON = JSON.stringify(msg);
            console.log(msgJSON);

            //send values in json to server
            connection.send(msgJSON);

            //disable input boxes and wait for the server to return connected
            document.getElementById("ErrorBox").hidden = true;
            document.getElementById("WelcomeBox").hidden = false;
            document.getElementById("Endpoint").disabled = true;
            document.getElementById("Endpoint").blur();
            document.getElementById("Device").disabled = true;
            document.getElementById("Device").blur();
            document.getElementById("Topic").disabled = true;
            document.getElementById("Topic").blur();
            document.getElementById("button").disabled = true;
            document.getElementById("WelcomeBox").hidden = true;
            document.getElementById("ConnectingBox").hidden = false;

        }
    });


</script>
</body>
</html>